name: Scrape Gold Price

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *' # Every hour
  workflow_dispatch: # Manual trigger option

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Full git history for better tracking

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Install dependencies
        run: go mod download

      - name: Run Go Scraper
        run: |
          echo "Starting price scraper..."
          go run main.go
          echo "Scraper completed successfully!"

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in CSV/JSON files"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

       - name: Commit and Push changes
  run: |
    git config user.name "Automated Scraper"
    git config user.email "actions@users.noreply.github.com"
    
    # Add all files
    git add fe/src/prices.csv fe/src/silver-prices.csv fe/src/prices.json fe/src/silver-prices.json
    
    timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
    
    # Commit even if no changes (with --allow-empty)
    git diff --cached --quiet && EMPTY="--allow-empty" || EMPTY=""
    
    git commit $EMPTY -m "üîÑ Auto update prices: ${timestamp}"
    git push origin main
    
    echo "‚úÖ Changes pushed to GitHub successfully!"

      - name: Summary
        if: always()
        run: |
          if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]]; then
            echo "‚úÖ Price data updated and pushed to GitHub"
          else
            echo "‚ÑπÔ∏è No price changes detected"
          fi
