name: Scrape Gold Price

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Playwright dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libdbus-1-3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64

      - name: Install Go dependencies
        run: |
          go mod download
          go mod tidy

      - name: Install Playwright browsers
        run: |
          go run github.com/playwright-community/playwright-go/cmd/playwright@latest install --with-deps chromium

      - name: Run Scraper
        run: |
          echo "ðŸš€ Starting scraper..."
          go run main.go
          echo "âœ… Scraper completed!"

      - name: Commit and Push changes
        run: |
          git config user.name "Automated Scraper"
          git config user.email "actions@users.noreply.github.com"
          
          git add fe/src/prices.csv fe/src/silver-prices.csv fe/src/prices.json fe/src/silver-prices.json
          git add error_screenshot.png error_page.html || true
          
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          git diff --cached --quiet && EMPTY="--allow-empty" || EMPTY=""
          
          git commit $EMPTY -m "ðŸ”„ Auto update prices: ${timestamp}"
          git push origin main
          
          echo "âœ… Changes pushed to GitHub!"
